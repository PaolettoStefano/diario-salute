<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoraggio Parametri Vitali</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  margin: 0;
  background: #f4f6f9;
}

header {
  background: #2c3e50;
  color: white;
  padding: 15px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}

.container {
  padding: 15px;
}

button {
  padding: 10px 15px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  margin-right: 5px;
  margin-bottom: 10px;
}

.primary {
  background: #3498db;
  color: white;
}

.success {
  background: #27ae60;
  color: white;
}

.export {
  background: #8e44ad;
  color: white;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: white;
  border-radius: 10px;
  overflow: hidden;
}

th, td {
  padding: 8px;
  text-align: center;
  font-size: 14px;
}

th {
  background: #34495e;
  color: white;
}

tr:nth-child(even) {
  background: #f2f2f2;
}

.month-header {
  background: #dfe6e9;
  font-weight: bold;
  text-align: left;
  padding: 10px;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 12px;
  width: 95%;
  max-width: 400px;
}

.modal-content h3 {
  margin-top: 0;
}

input {
  width: 100%;
  padding: 8px;
  margin: 5px 0 12px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.actions {
  display: flex;
  justify-content: space-between;
}
</style>
</head>

<body>

<header>Monitoraggio Parametri Vitali</header>

<div class="container">
  <button class="primary" onclick="openModal()">+ Inserisci</button>
  <button class="export" onclick="exportCSV()">Esporta Excel</button>
  <button onclick="downloadJSON()">Scarica dati.json</button>
  <button onclick="uploadJSON()">Carica dati.json</button>
  <input type="file" id="fileInput" style="display:none" accept=".json">

  <div id="tableContainer"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Inserisci Parametri</h3>

    <label>Data</label>
    <input type="date" id="data">

    <label>Ora</label>
    <input type="time" id="ora">

    <label>Pressione Massima</label>
    <input type="number" id="massima">

    <label>Pressione Minima</label>
    <input type="number" id="minima">

    <label>Pulsazioni</label>
    <input type="number" id="pulsazioni">

    <label>Temperatura (Â°C)</label>
    <input type="number" step="0.1" id="temp">

    <label>SP02 (%)</label>
    <input type="number" id="spo2">

    <label>BPM</label>
    <input type="number" id="bpm">

    <div class="actions">
      <button onclick="closeModal()">Annulla</button>
      <button class="success" onclick="saveData()">Salva</button>
    </div>
  </div>
</div>

<script>
let records = JSON.parse(localStorage.getItem("parametri")) || [];

function openModal() {
  const now = new Date();
  document.getElementById("data").value = now.toISOString().split('T')[0];
  document.getElementById("ora").value = now.toTimeString().slice(0,5);
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

function saveData() {
  const record = {
    data: data.value,
    ora: ora.value,
    massima: massima.value,
    minima: minima.value,
    pulsazioni: pulsazioni.value,
    temp: temp.value,
    spo2: spo2.value,
    bpm: bpm.value
  };

  records.push(record);
  localStorage.setItem("parametri", JSON.stringify(records));
  closeModal();
  renderTable();
}

function renderTable() {
  let container = document.getElementById("tableContainer");
  container.innerHTML = "";

  if(records.length === 0){
    container.innerHTML = "<p>Nessun dato registrato</p>";
    return;
  }

  let grouped = {};
  records.forEach(r => {
    let month = r.data.substring(0,7);
    if (!grouped[month]) grouped[month] = [];
    grouped[month].push(r);
  });

  Object.keys(grouped).sort().reverse().forEach(month => {
    let monthDiv = document.createElement("div");
    monthDiv.className = "month-header";
    monthDiv.innerText = "Mese: " + month + " (" + grouped[month].length + " misurazioni)";
    container.appendChild(monthDiv);

    let table = document.createElement("table");
    table.innerHTML = `
      <tr>
        <th>Data</th>
        <th>Ora</th>
        <th>Max</th>
        <th>Min</th>
        <th>Puls</th>
        <th>Temp</th>
        <th>SP02</th>
        <th>BPM</th>
      </tr>
    `;

    grouped[month].forEach(r => {
      table.innerHTML += `
        <tr>
          <td>${r.data}</td>
          <td>${r.ora}</td>
          <td>${r.massima}</td>
          <td>${r.minima}</td>
          <td>${r.pulsazioni}</td>
          <td>${r.temp}</td>
          <td>${r.spo2}</td>
          <td>${r.bpm}</td>
        </tr>
      `;
    });

    container.appendChild(table);
  });
}

function exportCSV() {
  let csv = "Data,Ora,Massima,Minima,Pulsazioni,Temp,SP02,BPM\n";
  records.forEach(r => {
    csv += `${r.data},${r.ora},${r.massima},${r.minima},${r.pulsazioni},${r.temp},${r.spo2},${r.bpm}\n`;
  });

  let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "parametri_vitali.csv";
  link.click();
}

function downloadJSON() {
  const blob = new Blob([JSON.stringify(records, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "dati.json";
  link.click();
}

function uploadJSON() {
  document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      records = JSON.parse(e.target.result);
      localStorage.setItem("parametri", JSON.stringify(records));
      renderTable();
      alert("Dati caricati correttamente!");
    } catch {
      alert("Errore nel file JSON");
    }
  };
  reader.readAsText(file);
});

renderTable();
</script>

</body>
</html>
