<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoraggio Parametri Vitali</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin:0; background:#f4f6f9; }
header { background:#2c3e50; color:white; padding:15px; text-align:center; font-size:20px; font-weight:bold; }
.container { padding:15px; }
button { padding:10px 15px; border-radius:8px; border:none; cursor:pointer; font-weight:600; margin-right:5px; margin-bottom:10px; }
.primary { background:#3498db; color:white; }
.success { background:#27ae60; color:white; }
.export { background:#8e44ad; color:white; }
.warning { background:#e67e22; color:white; }
.danger { background:#e74c3c; color:white; }
table { width:100%; border-collapse:collapse; margin-top:10px; background:white; border-radius:10px; overflow:hidden; }
th, td { padding:8px; text-align:center; font-size:14px; }
th { background:#34495e; color:white; }
tr:nth-child(even) { background:#f2f2f2; }
.month-header { background:#dfe6e9; font-weight:bold; text-align:left; padding:10px; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:12px; width:95%; max-width:400px; }
.modal-content h3 { margin-top:0; }
input { width:100%; padding:8px; margin:5px 0 12px 0; border-radius:6px; border:1px solid #ccc; }
.actions { display:flex; justify-content:space-between; }
#status { margin-bottom:10px; font-size:14px; }
</style>
</head>
<body>

<header>Monitoraggio Parametri Vitali</header>

<div class="container">
  <div id="status">Stato: <span id="statusText">Inizializzazione...</span></div>

  <div id="setupArea">
    <h3>‚öôÔ∏è Configurazione GitHub</h3>
    <input type="password" id="ghToken" placeholder="Personal Access Token">
    <input type="text" id="ghRepo" placeholder="utente/nome-repo">
    <button class="primary" onclick="saveSetup()">Connetti</button>
    <p style="font-size:12px;color:#555;">Assicurati che il file <b>dati.json</b> esista nella repo.</p>
  </div>

  <button class="primary" onclick="openModal()">+ Inserisci</button>
  <button class="export" onclick="exportCSV()">Esporta Excel</button>

  <div id="tableContainer"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Inserisci Parametri</h3>
    <label>Data</label><input type="date" id="data">
    <label>Ora</label><input type="time" id="ora">
    <label>Pressione Massima</label><input type="number" id="massima">
    <label>Pressione Minima</label><input type="number" id="minima">
    <label>Pulsazioni</label><input type="number" id="pulsazioni">
    <label>Temperatura (¬∞C)</label><input type="number" step="0.1" id="temp">
    <label>SP02 (%)</label><input type="number" id="spo2">
    <label>BPM</label><input type="number" id="bpm">
    <div class="actions">
      <button onclick="closeModal()">Annulla</button>
      <button class="success" onclick="saveData()">Salva</button>
    </div>
  </div>
</div>

<script>
let records = [];
let editIndex = -1;
let config = JSON.parse(localStorage.getItem('gh_health_config')) || null;
let fileSha = "";

function saveSetup() {
  const token = document.getElementById('ghToken').value.trim();
  const repo = document.getElementById('ghRepo').value.trim();
  if(token && repo){
    localStorage.setItem('gh_health_config', JSON.stringify({token, repo}));
    location.reload();
  }
}

function setStatus(msg, color='black'){
  document.getElementById('statusText').innerText = msg;
  document.getElementById('statusText').style.color = color;
}

async function ghFetch(){
  if(!config) return;
  setStatus("Caricamento dati...", "blue");
  const url = `https://api.github.com/repos/${config.repo}/contents/dati.json`;
  try {
    const res = await fetch(url, { headers:{ Authorization:`token ${config.token}`} });
    if(res.ok){
      const data = await res.json();
      fileSha = data.sha;
      records = JSON.parse(atob(data.content));
      renderTable();
      setStatus("Dati caricati", "green");
    } else if(res.status === 404){
      setStatus("File dati.json non trovato, creeremo uno nuovo", "orange");
    } else {
      setStatus("Errore fetch dati", "red");
    }
  } catch(e){
    setStatus("Offline o errore di rete", "red");
  }
}

async function ghPush(){
  if(!config) return;
  setStatus("Salvataggio dati...", "blue");
  const url = `https://api.github.com/repos/${config.repo}/contents/dati.json`;
  const body = {
    message: "Aggiornamento " + new Date().toLocaleString(),
    content: btoa(unescape(encodeURIComponent(JSON.stringify(records,null,2)))),
    sha: fileSha
  };
  try{
    const res = await fetch(url,{
      method:"PUT",
      headers:{ "Authorization":`token ${config.token}`, "Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if(res.ok){
      const data = await res.json();
      fileSha = data.content.sha;
      setStatus("Dati salvati su GitHub", "green");
    } else {
      setStatus("Errore salvataggio", "red");
    }
  } catch(e){
    setStatus("Errore salvataggio", "red");
  }
}

function openModal(index=-1){
  const now = new Date();
  if(index>=0){
    const r = records[index];
    data.value=r.data; ora.value=r.ora; massima.value=r.massima; minima.value=r.minima;
    pulsazioni.value=r.pulsazioni; temp.value=r.temp; spo2.value=r.spo2; bpm.value=r.bpm;
    modalTitle.innerText="Modifica Parametri";
    editIndex=index;
  } else {
    data.value=now.toISOString().split('T')[0];
    ora.value=now.toTimeString().slice(0,5);
    modalTitle.innerText="Inserisci Parametri";
    editIndex=-1;
    document.querySelectorAll("#modal input").forEach(i=>i.value="");
  }
  modal.style.display="flex";
}

function closeModal(){ modal.style.display="none"; }

function saveData(){
  const r = { data:data.value, ora:ora.value, massima:massima.value, minima:minima.value,
              pulsazioni:pulsazioni.value, temp:temp.value, spo2:spo2.value, bpm:bpm.value };
  if(editIndex>=0) records[editIndex]=r; else records.push(r);
  renderTable();
  ghPush();
  closeModal();
}

function deleteRecord(i){
  if(confirm("Eliminare questo record?")){
    records.splice(i,1);
    renderTable();
    ghPush();
  }
}

function renderTable(){
  const container=document.getElementById("tableContainer");
  container.innerHTML="";
  if(records.length===0){ container.innerHTML="<p>Nessun dato registrato</p>"; return; }

  let grouped={};
  records.forEach((r,i)=>{ const month=r.data.substring(0,7); if(!grouped[month]) grouped[month]=[]; grouped[month].push({...r,index:i}); });

  Object.keys(grouped).sort().reverse().forEach(month=>{
    const div=document.createElement("div"); div.className="month-header";
    div.innerText="Mese: "+month+" ("+grouped[month].length+" misurazioni)"; container.appendChild(div);

    const table=document.createElement("table");
    table.innerHTML=`<tr>
      <th>Data</th><th>Ora</th><th>Max</th><th>Min</th><th>Puls</th><th>Temp</th><th>SP02</th><th>BPM</th><th>Azioni</th>
    </tr>`;
    grouped[month].forEach(r=>{
      table.innerHTML+=`<tr>
        <td>${r.data}</td><td>${r.ora}</td><td>${r.massima}</td><td>${r.minima}</td>
        <td>${r.pulsazioni}</td><td>${r.temp}</td><td>${r.spo2}</td><td>${r.bpm}</td>
        <td><button class="warning" onclick="openModal(${r.index})">‚úèÔ∏è</button>
        <button class="danger" onclick="deleteRecord(${r.index})">üóëÔ∏è</button></td>
      </tr>`;
    });
    container.appendChild(table);
  });
}

function exportCSV(){
  let csv="Data,Ora,Massima,Minima,Pulsazioni,Temp,SP02,BPM\n";
  records.forEach(r=>{ csv+=`${r.data},${r.ora},${r.massima},${r.minima},${r.pulsazioni},${r.temp},${r.spo2},${r.bpm}\n`; });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="parametri.csv"; a.click();
}

// inizializzazione
if(config){ ghFetch(); } else { setStatus("Inserisci token e repo per attivare GitHub","orange"); }
</script>

</body>
</html>
